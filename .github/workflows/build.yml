name: build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    environment: dev

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-east-1
      AWS_DEFAULT_OUTPUT: json

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Package Python Lambda Functions
        run: |
          cd Lambdas/image_gen
          zip -r ../../image_gen.zip main.py
          cd ../..
          cd Lambdas/twitter_post
          zip -r ../../twitter_post.zip main.py
          cd ../..
          ls -la
          echo "Contents of image_gen.zip:"
          unzip -l image_gen.zip
          echo "Contents of twitter_post.zip:"
          unzip -l twitter_post.zip

      - name: Package Node Lambda Function
        run: |
          cd Lambdas/gallery_api
          npm install
          npm run build
          zip -r ../../gallery_api.zip dist/src/ node_modules/ package.json
          cd ../..
          ls -la
          echo "Contents of gallery_api.zip:"
          unzip -l gallery_api.zip | head -20

      - name: Package Python Lambda Layers
        run: |
          docker run --rm --entrypoint /bin/bash -v $(pwd):/workspace public.ecr.aws/lambda/python:3.10 \
            -c "pip install -r /workspace/Lambdas/image_gen/requirements.txt -t /workspace/layer_image_gen/python && chown -R $(id -u):$(id -g) /workspace/layer_image_gen"
          cd layer_image_gen
          zip -r ../image_gen_layer.zip python
          cd ..
          docker run --rm --entrypoint /bin/bash -v $(pwd):/workspace public.ecr.aws/lambda/python:3.10 \
            -c "pip install -r /workspace/Lambdas/twitter_post/requirements.txt -t /workspace/layer_twitter_post/python && chown -R $(id -u):$(id -g) /workspace/layer_twitter_post"
          cd layer_twitter_post
          zip -r ../twitter_post_layer.zip python
          cd ..
          ls -la
          echo "Contents of image_gen_layer.zip:"
          unzip -l image_gen_layer.zip | head -20
          echo "Contents of twitter_post_layer.zip:"
          unzip -l twitter_post_layer.zip | head -20

      - name: Upload Zip Files to S3
        run: |
          aws s3 cp image_gen.zip ${{ secrets.S3_BUCKET }}/image_gen.zip
          aws s3 cp twitter_post.zip ${{ secrets.S3_BUCKET }}/twitter_post.zip
          aws s3 cp gallery_api.zip ${{ secrets.S3_BUCKET }}/gallery_api.zip
          
      - name: Update Lambda Filename TFE Variable Values
        run: |
          curl -s --header "Authorization: Bearer ${{ secrets.TFE_TOKEN }}" --header "Content-Type: application/vnd.api+json" --request PATCH --data '{"data":{"id":"${{ secrets.TFE_IMAGE_VAR_ID }}","attributes":{"key":"${{ secrets.TFE_IMAGE_KEY }}","value":"image_gen.zip","category":"terraform","hcl":false,"sensitive":false},"type":"vars"}}' "https://app.terraform.io/api/v2/workspaces/${{ secrets.TFE_WORKSPACE_ID }}/vars/${{ secrets.TFE_IMAGE_VAR_ID }}"
          curl -s --header "Authorization: Bearer ${{ secrets.TFE_TOKEN }}" --header "Content-Type: application/vnd.api+json" --request PATCH --data '{"data":{"id":"${{ secrets.TFE_TWITTER_VAR_ID }}","attributes":{"key":"${{ secrets.TFE_TWITTER_KEY }}","value":"twitter_post.zip","category":"terraform","hcl":false,"sensitive":false},"type":"vars"}}' "https://app.terraform.io/api/v2/workspaces/${{ secrets.TFE_WORKSPACE_ID }}/vars/${{ secrets.TFE_TWITTER_VAR_ID }}"
          curl -s --header "Authorization: Bearer ${{ secrets.TFE_TOKEN }}" --header "Content-Type: application/vnd.api+json" --request PATCH --data '{"data":{"id":"${{ secrets.TFE_GALLERY_VAR_ID }}","attributes":{"key":"${{ secrets.TFE_GALLERY_KEY }}","value":"gallery_api.zip","category":"terraform","hcl":false,"sensitive":false},"type":"vars"}}' "https://app.terraform.io/api/v2/workspaces/${{ secrets.TFE_WORKSPACE_ID }}/vars/${{ secrets.TFE_GALLERY_VAR_ID }}"
      - name: Upload Python Lambda Layers
        if: ${{ vars.UPLOAD_LAYERS == 'true' }}
        run: |
          aws lambda publish-layer-version \
            --layer-name image_gen_layer \
            --zip-file fileb://image_gen_layer.zip \
            --compatible-runtimes python3.10 \
            --description "Dependencies for image generation lambda"
          
          aws lambda publish-layer-version \
            --layer-name twitter_post_layer \
            --zip-file fileb://twitter_post_layer.zip \
            --compatible-runtimes python3.10 \
            --description "Dependencies for twitter post lambda"

      - name: Update Python Lambda Layer Filename TFE Variable Values
        if: ${{ vars.UPLOAD_LAYERS == 'true' }}
        run: |
          curl -s --header "Authorization: Bearer ${{ secrets.TFE_TOKEN }}" --header "Content-Type: application/vnd.api+json" --request PATCH --data '{"data":{"id":"${{ secrets.TFE_IMAGE_LAYER_VAR_ID }}","attributes":{"value":"image_gen_layer","category":"terraform","hcl":false,"sensitive":false},"type":"vars"}}' "https://app.terraform.io/api/v2/workspaces/${{ secrets.TFE_WORKSPACE_ID }}/vars/${{ secrets.TFE_IMAGE_LAYER_VAR_ID }}"
          curl -s --header "Authorization: Bearer ${{ secrets.TFE_TOKEN }}" --header "Content-Type: application/vnd.api+json" --request PATCH --data '{"data":{"id":"${{ secrets.TFE_TWITTER_LAYER_VAR_ID }}","attributes":{"value":"twitter_post_layer","category":"terraform","hcl":false,"sensitive":false},"type":"vars"}}' "https://app.terraform.io/api/v2/workspaces/${{ secrets.TFE_WORKSPACE_ID }}/vars/${{ secrets.TFE_TWITTER_LAYER_VAR_ID }}"