name: security scan

on:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'

      - name: Run Bandit SAST - Python
        continue-on-error: true
        run: |
          python -m pip install bandit[sarif]
          python -m bandit -r Lambdas/ -f sarif -o bandit-results.sarif --severity-level high

      - name: Upload Bandit Results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bandit-results.sarif
          category: bandit

      - name: Run pip-audit Dependency Scanning - Python
        continue-on-error: true
        run: |
          python -m pip install pip-audit
          echo "=== Scanning image_gen dependencies ==="
          python -m pip_audit -r Lambdas/image_gen/requirements.txt --format json
          echo ""
          echo "=== Scanning twitter_post dependencies ==="
          python -m pip_audit -r Lambdas/twitter_post/requirements.txt --format json

      - name: Run Semgrep SAST - Node.js
        continue-on-error: true
        run: |
          python -m pip install semgrep
          semgrep scan --config p/ci --sarif --output semgrep-results.sarif Lambdas/gallery_api/

      - name: Upload Semgrep Node Results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-node-results.sarif
          category: semgrep-nodejs

      - name: Run Semgrep SAST - React
        continue-on-error: true
        run: |
          semgrep scan --config p/ci --sarif --output semgrep-react-results.sarif Frontend/

      - name: Upload Semgrep React Results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-react-results.sarif
          category: semgrep-react

      - name: Run npm audit Dependency Scanning - Node.js
        continue-on-error: true
        run: |
          cd Lambdas/gallery_api
          npm audit --audit-level=moderate --json > npm-audit-results.json || true
          cat npm-audit-results.json

      - name: Run npm audit Dependency Scanning - React
        continue-on-error: true
        run: |
          cd Frontend
          npm audit --audit-level=moderate --json > npm-audit-react-results.json || true
          cat npm-audit-react-results.json

      - name: Run OWASP Dependency-Check
        continue-on-error: true
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'Spooky Days Twitter'
          path: '.'
          format: 'SARIF'
          out: 'owasp-dependency-check-results.sarif'
          args: >
            --enableRetired
            --enableExperimental
            --nvdValidForHours 24

      - name: Upload OWASP Dependency-Check Results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: dependency-check-results.sarif
          category: dependency-check

      - name: Run Gitleaks Secret Scanning
        continue-on-error: true
        uses: gitleaks/gitleaks-action@v2.3.6
        with:
          scan-mode: full
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_SUMMARY: true

      - name: Run Trivy Terraform Scanning
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'config'
          scan-ref: 'Terraform/'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy Results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif
          category: trivy-terraform

      - name: Run Trivy Dependency Scanning
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: 'Lambdas/gallery_api/package.json,Frontend/package.json,Lambdas/image_gen/requirements.txt,Lambdas/twitter_post/requirements.txt'
          format: 'sarif'
          output: 'trivy-dep-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy Dependency Results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-dep-results.sarif
          category: trivy-dependencies
